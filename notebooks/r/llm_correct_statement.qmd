---
title: "PDF to statement CSV"
author: "Raphael Merz"
format: html
editor: visual
---

# LLM correct incorrect statements

## 0 Preparation

### Load packages

```{r}
#| message: false
# install.packages("devtools") 
# devtools::install_github("scienceverse/papercheck")
library(papercheck)
library(tidyverse)
library(readxl)
```

### Load data

```{r}
data_path <- "../../data/training_data/labeled/labeled_data.xlsx" # path to where the csv with human-labeled statements is

corrected_path <- "../../data/llm_correction_check/llm_correction_unchecked.csv"# path to where the final csv with the corrected statements should be stored

# Load data
labeled_data <- read_excel(data_path)

# Create subset with only relevant columns and rename
subset_df <- labeled_data %>%
  select(statement = expanded, label)

# Sample 80 incorrect (label == 1) and 20 correct (label == 0) statements
set.seed(42)  # for reproducibility
subset_sample <- bind_rows(
  sample_n(filter(subset_df, label == 1), 80),
  sample_n(filter(subset_df, label == 0), 20)
)

# Shuffle the combined set
subset_sample <- subset_sample %>% sample_frac(1)
```

### Check llm() setup

```{r}
if (Sys.getenv("GROQ_API_KEY") != "") {
  message("GROQ_API_KEY is set.")
} else {
  warning("GROQ_API_KEY is NOT set.")
}

# Either set a groq API key in the llm() function
# llm(..., API_KEY = "your_api_key")

# Or run this line to open the R Environment file and put your API key there (recommended)
# usethis::edit_r_environ() # and add: GROQ_API_KEY="your_api_key"
```

## 1 Send incorrect statements to LLM

### Prompt

```{r}
prompt <- "
Below you see a statement that was classified as a misinterpretation of a nonsignificant finding as the absence of an effect. This could be because the authors explicitly say that there is or was no effect/difference/association etc., but they could also say that groups/conditions etc. where similar/comparable or something similar.

Your job is to correct this. It could be that there is a correct and an incorrect interpretation (e.g., first 'no significant difference' and then 'there was no effect'), or multiple incorrect interpretations. Ignore any other potentially problematic things in the statements and try to stay as close to the originaly statement as possible, while still fixing any misinterpretations as no effect/similar, like described above.

Your response should only be the new, corrected version of the statement an nothing else.

If a statement very clearly contains no nonsignificant p value or no interpretation of it, or the statement doesn't seem to be complete or, e.g., part of a table and no sentence or so, reply with only 'NO CORRECTION POSSIBLE'.

Here's the statement with the misinterpretation:
"
```

### LLM setup

```{r}
temperature = .5 # papercheck explanation: Controls randomness in responses. Lower values make responses more deterministic. Recommended range: 0.5-0.7 to prevent repetitions or incoherent outputs; valued between 0 inclusive and 2 exclusive

# if you want to specify a specific model and not use the llm()-standard
# model = "your_model_here"
llm_model_list() # for a list of all available models

# there is a model specific rate limit for the groq API. The default is set to 30. If you want to change it, run this code and adjust the rate limit accordingly
# llm_max_calls(30)
```

### Ping LLM and store response

```{r}
# not best Practice, but for now set llm_max_calls() to 100 and send all statements at once
llm_max_calls(nrow(subset_sample))

# send each incorrect statement from the labeled dataset with above prompt to the llm
llm_response <- llm(text = subset_sample$statement, query = prompt)

head(llm_response)
```

## 2 Save csv with corrected statements

### Combining labeled_data with llm_response

```{r}
# Store in new dataframe
corrected <- subset_sample

# Save llm_response in corrected
corrected$corrected <- llm_response$answer

# Head 'corrected'
head(corrected)
```

### Save csv

```{r}
# save file as csv (csv2 because I will manually go through them)
write.csv2(corrected, file = corrected_path, row.names = F)
```
